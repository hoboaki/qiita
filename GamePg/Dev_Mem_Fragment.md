# メモリ断片化とその対策

ゲームアプリケーション上で、何も考えずにメモリの確保や解放を繰り返しているとメモリ断片化がおこります。

メモリ断片化は最悪のケースでゲームが停止してしまう原因となってしまいます。

今回はメモリ断片化がどうしておこるのか、そしてゲームプログラムでオススメの断片化対策についてお話します。


## メモリ断片化とは

メモリ断片化とは、メモリの確保や解放を繰り返した結果、連続した空きメモリ領域が少なくなる現象です。別名、フラグメンテーションとも呼びます。この記事では以降、断片化と略して表記します。

断片化のおこる詳しいメカニズムについては、こちらのサイトをご覧ください。図つきで分かりやすいです。

フラグメンテーション | 学校では教えてくれないこと | [技術コラム集]組込みの門 | ユークエスト株式会社
https://www.uquest.co.jp/embedded/learning/lecture17.html

## メモリ断片化の対策をしないと起こる事象

断片化の対策をしないと次のようなことがおこります。

- CPUキャッシュ効率が悪くなりパフォーマンスが低下する、
- 本来必要なメモリの確保に失敗しゲームアプリケーションが強制終了する。

前者は（程度にもよりますが）許容できたとしても、後者はプレイヤーのゲームプレイ体験に大きく影響してしまいます。

## 強制終了しなければ対策しなくていいんじゃないかという考え方

時々、「長時間のテストプレイで問題がでなければ断片化対策は不要だ」という考え方のプログラマさんと出会います。対策も対応コストはゼロではないですしゲーム開発にかけられるコストも無限ではありませんからそれも１つの考え方だと自分も考えます。

ただこうした考えを採用した場合、次の懸念事項を承諾したと同義であることに気をつけてください。

1. 『長時間のテストプレイ』における必要十分な時間は○○時間ですと言い切れること。
1. 断片化による不具合が発生するのを確認から対策する場合、余計に対策コストがかかる可能性があること。
1. ↑の状況が開発終盤に起きても大丈夫だと言い切れること。

趣味で製作しているフリーソフトのゲームであればそこまでを気を張る必要はないですからこの考え方を採用しても問題ありません。しかし、商用のゲームであればそれは売り物です。開発に責任を持つという意味で、この考え方を採用した場合の懸念事項と向き合っておきましょう。


> 1番についての補足
> 
> 例えば対戦格闘ゲームで1試合終わる毎にメモリがクリアされることが保証されているのであれば『十分な時間』が定義できそうです。ただし、1試合に対して制限時間がない場合は『十分な時間』の定義が難しくなります。

## メモリ断片化の対策方法の紹介

いくつかある断片化対策の方法を紹介していきます。

### 対策方法1. メモリ確保したものと逆順にメモリ解放することを徹底する

A,B、Cという順番にメモリ確保したのであればC,B,Aの順番で目折り解放すれば断片化はおこりません。これを徹底すれば断片化はおきない、・・・という極めてシンプルな方法です。ただし、これを全てのメモリブロックに対して行うのはなかなか大変です。

### 対策方法2. 最大必要量で事前に確保したメモリブロックを使い回す

例えば次のようなケースを想像してみてください。

- 3Dモデルアニメーションの計算にワークメモリが必要。
- ワークメモリに必要な容量はアニメーションのデータによって異なる。
- 3Dモデルアニメーションは同時に１つしか再生しないものとする。

素直に実装すると、アニメーションを再生するたびに新規にワークメモリ用のメモリを確保し、アニメーションが終了したらメモリを解放することになるでしょう。しかしそうすると断片化が発生してしまう可能性がでてきます。

このようなケースで、もし一番容量を使うアニメーションのデータが分かっているのであれば、そのデータが必要とするワークメモリサイズのメモリブロックを事前に確保しておきます。先に確保しておいたそのメモリブロックをワークメモリに割り当てて使用するれば、不要なメモリ確保・解放がおきず、結果断片化を防げます。

### 対策方法3. メモリ解放は一気に行う

断片化はメモリ解放をメモリ確保の合間に行うときに発生します。であれば、メモリ確保の合間にメモリ解放しなければ断片化は起きない、という方法です。

もちろんメモリ解放を一切しないといずれメモリは枯渇してしまいますので、この方法を採用した場合はメモリ確保が無尽蔵に増えないようにする対策が必須となります。

例えばキャラクタの出現や消失が何回も起こるようなゲームがあったとして、何も考えずに実装するとキャラクタの出現や消失のたびにメモリ確保とメモリ解放がおきてしまいます。このようなケースでは、一度消失したキャラクタが使用していたメモリブロックを空きメモリブロックとみなします。この空きメモリブロックを次に出現するキャラクタが使用することにより、新しいメモリ確保がおこらないようにできます。もし確保済みの空きメモリブロックがなければそのときは新たにメモリを確保します。そうして、ステージが切り替わる画面暗転タイミングなどで今まで確保してきたキャラクタのメモリブロックを一気に解放すれば断片化はおきずにメモリ解放ができます。

### 対策方法4. 確保するメモリブロックサイズを統一する

断片化は確保するメモリブロックのサイズがバラバラなときに起こります。であれば、確保するメモリブロックのサイズを統一すれば断片化は起きない、という方法です。

例えば、Aは128バイト、Bは512バイト、Cは64バイト、それぞれ必要だったとします。この場合、AやCがメモリ確保するときも最大サイズである512バイト確保します。

無駄なメモリ空間が発生するというデメリットと引き替えに断片化を防ぐことができます。

### 対策方法5. メモリブロックの寿命に合わせてメモリ確保処理を変える

とても寿命が短いメモリブロックの確保と解放は断片化の原因になりやすいです。マルチスレッドなゲームはもちろんですがシングルスレッドなゲームでもわりと起こります。

一時的に確保するようなメモリブロックはそれ専用のメモリ空間から確保すると断片化が発生しづらくなります。

> Tips
>
> システムによってはメモリを確保する際にヒープの前方からとるか後方からとるか選べる機能があります。そのようなシステムでは、寿命が長いものは前方から、一時的なものは後方からメモリ確保することでこの方法を実現できます。

### 対策方法6. そもそも断片化を解消する仕組みを導入する

断片化がおきてもそれを解消してくれる仕組みがあれば断片化を心配する必要はなくなるはずです。この断片化を解消する処理をメモリコンパクションといいます。

メモリコンパクションは断片化した使用中のメモリブロックをヒープ上で移動させて断片化をなくします。

メモリコンパクションを入れれば全てを解決できそうに聞こえるかもしれません。しかし、メモリコンパクションは特殊なメモリ管理が必要とされ、またその処理負荷も決して軽いとはいえません。そのため、もしメモリコンパクションを採用するとしても採用するモジュールの範囲や容量・ブロック数などを最適化する必要があります。

## 対策方法は組み合わせて使う

ここで紹介したものどれか１つを採用する、というのではなく組み合わせて使うことが重要です。

ゲームアプリケーション上のメモリ確保・解放の性質はモジュール・ライブラリによってそれぞれ異なります。ですので、それぞれにあったものを採用して使うとよいでしょう。

例えば、ゲーム起動時に解消してそれからずっと破棄しないようなものは1番を。ある程度メモリブロックサイズが小さく大量に必要とされるようなものは3番を。3Dモデルやモーションなどのバイナリリソースは5番を。といった感じです。

どこに何を使えばいいのかというのに正解はありませんので、それぞれのゲームアプリケ-ション、もしくはゲームエンジンにあった対策をとってください。

## 仮想アドレス対応OSで断片化対策は不要？

OSによっては仮想アドレスという機能をサポートしています。PC環境では昔からあったもので、最近では一部のコンシューマゲーム機でも採用するものが出てきたと聞いています。

仮想アドレスをサポートするOSでは適当にメモリ解放やメモリ確保を繰り返してもある程度断片化されないようにできているようです。ただし、それも完全ではないため絶対安心とは言い切れません。

> 仮想アドレスについて詳しく知りたい方は「仮想アドレス ページング」といったキーワードでインターネット検索してみてください。

また、仮想アドレスを使うにはOSの用意するメモリ確保・メモリ解放を実行する必要がありOSによってはオーバーヘッドがかかる可能性があります。ちなみに仮想アドレスを採用していない従来のコンシューマーゲーム機では、オーバーヘッドを最低限にするため起動時にメモリを一括確保してアプリケーション側でヒープを作成しメモリ管理するのが主流でした。（※注
：少なくとも筆者はそう認識しています）

絶対安心とはなりませんが仮想アドレス対応OSでオーバーヘッドなど気にならないような環境では断片化対策をOSに任せるというのも対策の１つと考えてよいでしょう。

## おわり

以上、メモリ断片化とその対策のお話でした。

ゲームアプリケーション開発においてチーム内のプログラマ全員が断片化を気をつけながらコーディングできればそれにこしたことはありません。ですが、全員にそれを求めるのは困難ですし、そもそも断片化を気にせずコーディングできたほうがクリエイティブなことに集中できます。

ですので、チーム内で断片化を気にしなくてよいシステムを用意し、そのシステムの上で多くのプログラマがコーデイングできるようにすることが大事だと筆者は考えます。

リンク：[ゲームプログラマの小話-目次](http://www.10106.net/~hoboaki/wiki/index.php?%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9E%E3%81%AE%E5%B0%8F%E8%A9%B1)

