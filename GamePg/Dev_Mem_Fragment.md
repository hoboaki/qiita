# メモリ断片化とその対策

ゲームアプリケーション上で、何も考えずにメモリの確保や解放を繰り返しているとメモリ断片化がおこります。

メモリ断片化は最悪のケースでゲームが停止してしまう原因となってしまいます。

今回はメモリ断片化がどうしておこるのか、そしてゲームプログラムでオススメの断片化対策についてお話します。


## メモリ断片化とは

メモリ断片化とは、メモリの確保や解放を繰り返した結果、連続した空きメモリ領域が少なくなる現象です。別名、フラグメンテーションとも呼びます。この記事では以降、断片化と略して表記します。

断片化のおこる詳しいメカニズムについては、こちらのサイトをご覧ください。図つきで分かりやすいです。

フラグメンテーション | 学校では教えてくれないこと | [技術コラム集]組込みの門 | ユークエスト株式会社
https://www.uquest.co.jp/embedded/learning/lecture17.html

## メモリ断片化の対策をしないと起こる事象

断片化の対策をしないと次のようなことがおこります。

- CPUキャッシュ効率が悪くなりパフォーマンスが低下する、
- 本来必要なメモリの確保に失敗しゲームアプリケーションが強制終了する。

前者は（程度にもよりますが）許容できたとしても、後者はプレイヤーのゲームプレイ体験に大きく影響してしまいます。

## 強制終了しなければ対策しなくていいんじゃないかという考え方

時々、「長時間のテストプレイで問題がでなければ断片化対策は不要だ」という考え方のプログラマさんと出会います。対策も対応コストはゼロではないですしゲーム開発にかけられるコストも無限ではありませんからそれも１つの考え方だと自分も考えます。

ただこうした考えを採用した場合、次の懸念事項を承諾したと同義であることに気をつけてください。

1. 『長時間のテストプレイ』における必要十分な時間は○○時間ですと言い切れること。
1. 断片化による不具合が発生するのを確認から対策する場合、余計に対策コストがかかる可能性があること。
1. ↑の状況が開発終盤に起きても大丈夫だと言い切れること。

趣味で製作しているフリーソフトのゲームであればそこまでを気を張る必要はないですからこの考え方を採用しても問題ありません。しかし、商用のゲームであればそれは売り物です。開発に責任を持つという意味で、この考え方を採用した場合の懸念事項と向き合っておきましょう。


> 1番についての補足
> 
> 例えば対戦格闘ゲームで1試合終わる毎にメモリがクリアされることが保証されているのであれば『十分な時間』が定義できそうです。ただし、1試合に対して制限時間がない場合は『十分な時間』の定義が難しくなります。

## メモリ断片化の対策方法の紹介

いくつかある断片化対策の方法を紹介していきます。

### 対策方法1. メモリ確保したものと逆順にメモリ解放することを徹底する

A,B、Cという順番にメモリ確保したのであればC,B,Aの順番で目折り解放すれば断片化はおこりません。これを徹底すれば断片化はおきない、・・・という極めてシンプルな方法です。ただし、これを全てのメモリブロックに対して行うのはなかなか大変です。

### 対策方法2. メモリ解放は一気に行う

断片化はメモリ解放をメモリ確保の合間に行うときに発生します。であれば、メモリ確保の合間にメモリ解放しなければ断片化は起きない、という方法です。

もちろんメモリ解放を一切しないといずれメモリは枯渇してしまいますので、メモリ確保が無尽蔵に増えないようにする工夫が必要です。

例えばキャラクタの出現や消失が何回も起こるようなゲームがあったとして、何も考えずに実装するとキャラクタの出現や消失のたびにメモリ確保とメモリ解放がおきてしまいます。このようなケースでは、一度消失したキャラクタが使用していたメモリブロックを次に出現するキャラクタが使用することにより、新しいメモリ確保がおこらないようにできます。そして、ステージが切り替わる画面暗転タイミングなどで今まで確保してきたキャラクタのメモリブロックを一気に解放すれば断片化はおきずにメモリ解放ができます。

### 対策方法3. 確保するメモリブロックサイズを統一する

断片化は確保するメモリブロックのサイズがバラバラなときに起こります。であれば、確保するメモリブロックのサイズを統一すれば断片化は起きない、という方法です。

例えば、Aは128バイト、Bは512バイト、Cは64バイト、それぞれ必要だったとします。この場合、AやCがメモリ確保するときも最大サイズである512バイト確保します。

無駄なメモリ空間が発生するというデメリットと引き替えに断片化を防ぐことができます。

### 対策方法4. メモリブロックの寿命に合わせてメモリ確保処理を変える

とても寿命が短いメモリブロックの確保と解放は断片化の原因になりやすいです。マルチスレッドなゲームはもちろんですがシングルスレッドなゲームでもわりと起こります。

一時的に確保するようなメモリブロックはそれ専用のメモリ空間から確保すると断片化が発生しづらくなります。

> Tips
>
> システムによってはメモリを確保する際にヒープの前方からとるか後方からとるか選べる機能があります。そのようなシステムでは、寿命が長いものは前方から、一時的なものは後方からメモリ確保することでこの方法を実現できます。

### 対策方法5. そもそも断片化を解消する仕組みを導入する

### 対策方法6. これら対策方法を組み合わせる

## 今日のポイント

## おわり

リンク：[ゲームプログラマの小話-目次](http://www.10106.net/~hoboaki/wiki/index.php?%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9E%E3%81%AE%E5%B0%8F%E8%A9%B1)

